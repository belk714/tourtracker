<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="Tour Tracker">
<title>Tour Tracker</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#0d1117;--surface:#161b22;--surface2:#21262d;--border:#30363d;--text:#e6edf3;--text2:#8b949e;--accent:#58a6ff;--houston:#f0883e;--houston-bg:rgba(240,136,62,.12);--green:#3fb950;--hover:#1c2128}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
a{color:var(--accent);text-decoration:none}
.container{max-width:1100px;margin:0 auto;padding:16px}
header{display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px;margin-bottom:16px}
h1{font-size:1.4rem;display:flex;align-items:center;gap:8px}
h1 span{font-size:1.6rem}
.controls{display:flex;gap:8px;flex-wrap:wrap}
input[type=text]{background:var(--surface);border:1px solid var(--border);color:var(--text);padding:8px 12px;border-radius:6px;font-size:.9rem;width:220px}
input::placeholder{color:var(--text2)}
button{background:var(--surface);border:1px solid var(--border);color:var(--text);padding:8px 14px;border-radius:6px;cursor:pointer;font-size:.85rem;white-space:nowrap}
button:hover{background:var(--surface2)}
button.active{background:var(--accent);color:#000;border-color:var(--accent)}
.add-group{display:flex;gap:0}
.add-group input{border-radius:6px 0 0 6px;width:170px}
.add-group button{border-radius:0 6px 6px 0;border-left:0;background:var(--accent);color:#000;font-weight:600}
.add-group button:hover{background:#79bbff}
.remove-artist{background:none;border:none;color:var(--text2);opacity:.3;cursor:pointer;font-size:.8rem;padding:0 4px;margin-left:6px;transition:opacity .15s}
.remove-artist:hover{opacity:1;color:var(--houston)}
.stats{font-size:.85rem;color:var(--text2);margin-bottom:12px;display:flex;gap:16px;flex-wrap:wrap}
.stats b{color:var(--text)}
.badge{display:inline-block;padding:2px 8px;border-radius:10px;font-size:.75rem;font-weight:600}
.badge-houston{background:var(--houston-bg);color:var(--houston)}
table{width:100%;border-collapse:collapse;font-size:.9rem}
thead th{text-align:left;padding:10px 12px;border-bottom:2px solid var(--border);color:var(--text2);font-size:.8rem;text-transform:uppercase;letter-spacing:.5px;position:sticky;top:0;background:var(--bg);cursor:pointer;user-select:none}
tbody tr{border-bottom:1px solid var(--border);cursor:pointer;transition:background .15s}
tbody tr:hover{background:var(--hover)}
tbody td{padding:10px 12px}
tr.houston-row{background:var(--houston-bg)}
tr.houston-row:hover{background:rgba(240,136,62,.2)}
.artist-name{font-weight:600}
.venue-name{color:var(--text)}
.venue-link{color:var(--accent);text-decoration:none;cursor:pointer}
.venue-link:hover{text-decoration:underline}
.city-name{color:var(--text2)}
.date-col{white-space:nowrap}
.loading{text-align:center;padding:60px 20px;color:var(--text2)}
.loading .spinner{display:inline-block;width:28px;height:28px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .8s linear infinite;margin-bottom:12px}
@keyframes spin{to{transform:rotate(360deg)}}
.progress-bar{width:100%;height:4px;background:var(--surface);border-radius:2px;margin-bottom:16px;overflow:hidden}
.progress-fill{height:100%;background:var(--accent);transition:width .3s;border-radius:2px}
.back-btn{margin-bottom:12px}
.detail-header{margin-bottom:16px}
.detail-header h2{font-size:1.2rem;margin-bottom:4px}
.detail-header p{color:var(--text2);font-size:.9rem}
.no-events{text-align:center;padding:40px;color:var(--text2)}
.pill{display:inline-block;padding:3px 10px;border-radius:12px;font-size:.75rem;margin-left:8px;background:var(--surface2);color:var(--text2)}
.error-note{color:var(--text2);font-size:.8rem;font-style:italic}
.artist-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:8px}
.artist-list-item{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;background:var(--surface);border:1px solid var(--border);border-radius:6px;cursor:pointer;transition:all .15s;gap:12px}
.artist-list-item:hover{background:var(--surface2);border-color:var(--accent)}
.artist-list-item .left{display:flex;align-items:center;gap:12px;overflow:hidden}
.artist-list-item .artist-thumb{width:44px;height:44px;border-radius:50%;object-fit:cover;flex-shrink:0;background:var(--surface2)}
.artist-list-item .name{font-weight:600;font-size:.9rem}
.artist-list-item .info{font-size:.75rem;color:var(--text2)}
.artist-list-item .remove-x{background:none;border:none;color:var(--text2);opacity:.3;cursor:pointer;font-size:.9rem;padding:2px 6px;transition:opacity .15s}
.artist-list-item .remove-x:hover{opacity:1;color:var(--houston)}
.artist-list-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
.artist-list-header h2{font-size:1.2rem}
.artist-list-header span{color:var(--text2);font-size:.85rem}
@media(max-width:700px){
  input[type=text]{width:100%}
  .controls{width:100%}
  table{font-size:.82rem}
  thead th,tbody td{padding:8px 6px}
  .hide-mobile{display:none}
}
</style>
</head>
<body>
<div class="container">
  <header>
    <h1><span>üé∏</span> Tour Tracker</h1>
    <div class="controls">
      <input type="text" id="search" placeholder="Search artists, venues, cities‚Ä¶">
      <button id="houstonBtn" onclick="toggleHoustonFilter()">ü§† Houston Only</button>
      <button id="artistsBtn" onclick="showArtistList()">üé§ My Artists</button>
      <button id="refreshBtn" onclick="fetchAllEvents()">‚Üª Refresh</button>
    </div>
  </header>
  <div class="progress-bar"><div class="progress-fill" id="progress" style="width:0%"></div></div>
  <div class="stats" id="stats"></div>
  <div id="content">
    <div class="loading"><div class="spinner"></div><br>Loading tour dates‚Ä¶</div>
  </div>
</div>

<script>
const DEFAULT_ARTISTS = [
  "Jack Garratt","Dire Straits","Kishi Bashi","Elliott Smith","Jean Dawson",
  "Bombay Bicycle Club","From Indian Lakes","Petey","Minus the Bear","Geese",
  "Khruangbin","Djo","Tune-Yards","Red Hot Chili Peppers","Mt. Joy",
  "Arm's Length","Neil Young","Darling Farm","Arc De Soleil","R√úF√úS DU SOL",
  "Bob Dylan","The War On Drugs","Tom Misch","Peach Pit","Snail Mail",
  "Red Clay Strays","IDK","Dijon","Vince Guaraldi Trio","Chet Faker",
  "Jack Johnson","Paul Simon","Mo Lowda & the Humble","Palace",
  "Hermanos Guti√©rrez","Parcels","Blanco White","Rainbow Kitten Surprise",
  "The Used","Dispatch","Men I Trust","Radiohead","Empire of the Sun",
  "Paramore","Kanye West","The 1975","Dave Matthews Band"
];

const WORKER_URL = 'https://tour-tracker-api.belk714.workers.dev';
let ARTISTS = [...DEFAULT_ARTISTS];

async function loadArtistsFromRepo() {
  try {
    const r = await fetch(WORKER_URL + '/artists');
    if (r.ok) {
      const data = await r.json();
      if (Array.isArray(data) && data.length) {
        ARTISTS = data;
        return;
      }
    }
  } catch(e) {}
  ARTISTS = [...DEFAULT_ARTISTS];
}

async function addNewArtist() {
  const input = document.getElementById('addArtist');
  const name = input.value.trim();
  if (!name) return;
  if (ARTISTS.some(a => a.toLowerCase() === name.toLowerCase())) { input.value = ''; return; }
  input.value = '';
  try {
    const r = await fetch(WORKER_URL + '/artists', {
      method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({name})
    });
    if (r.ok) { const d = await r.json(); ARTISTS = d.artists; }
    else { ARTISTS.push(name); }
  } catch(e) { ARTISTS.push(name); }
  const events = await fetchArtistEvents(name);
  allEvents.push(...events);
  allEvents.sort((a,b) => {
    if (a._houston !== b._houston) return a._houston ? -1 : 1;
    return new Date(a.datetime) - new Date(b.datetime);
  });
  showArtistList();
}

let inArtistList = false;

async function removeArtist(name, evt) {
  evt.stopPropagation();
  ARTISTS = ARTISTS.filter(a => a !== name);
  allEvents = allEvents.filter(e => e._artist !== name);
  try {
    const r = await fetch(WORKER_URL + '/artists', {
      method: 'DELETE', headers: {'Content-Type':'application/json'}, body: JSON.stringify({name})
    });
    if (r.ok) { const d = await r.json(); ARTISTS = d.artists; }
  } catch(e) {}
  if (detailArtist === name) detailArtist = null;
  if (inArtistList) showArtistList();
  else renderMainView();
}

const HOUSTON_CITIES = ["houston","sugar land","the woodlands","galveston","kemah",
  "katy","pearland","league city","pasadena","cypress","spring","humble",
  "baytown","missouri city","richmond","rosenberg","conroe","tomball",
  "friendswood","webster","clear lake","stafford","bellaire"];

const APP_ID = "squarespace-belk714";
const artistImages = {};
let allEvents = [];
let houstonOnly = false;
let detailArtist = null;
let loaded = 0;
let errors = [];

function isHouston(event) {
  const city = (event.venue?.city || "").toLowerCase();
  const region = (event.venue?.region || "").toLowerCase();
  // Must be in Texas first
  if (region !== "tx" && region !== "texas") return false;
  return HOUSTON_CITIES.some(h => city.includes(h));
}

function formatDate(dt) {
  const d = new Date(dt);
  return d.toLocaleDateString('en-US', {weekday:'short', month:'short', day:'numeric', year:'numeric'});
}

function venueSearchUrl(venue) {
  const name = venue?.name || '';
  const city = venue?.city || '';
  const region = venue?.region || '';
  const q = encodeURIComponent(`${name} ${city} ${region} events calendar`);
  return `https://www.google.com/search?q=${q}`;
}

function formatDateShort(dt) {
  const d = new Date(dt);
  return d.toLocaleDateString('en-US', {month:'short', day:'numeric'});
}

async function fetchArtistEvents(artist) {
  const url = `https://rest.bandsintown.com/artists/${encodeURIComponent(artist)}/events?app_id=${APP_ID}&date=upcoming`;
  try {
    const r = await fetch(url);
    if (!r.ok) throw new Error(`${r.status}`);
    const data = await r.json();
    if (!Array.isArray(data)) return [];
    if (data.length > 0 && data[0].artist?.thumb_url) {
      artistImages[artist] = data[0].artist.thumb_url;
    }
    return data.map(e => ({...e, _artist: artist, _houston: isHouston(e)}));
  } catch(e) {
    errors.push({artist, error: e.message});
    return [];
  }
}

async function fetchAllEvents() {
  allEvents = [];
  errors = [];
  loaded = 0;
  detailArtist = null;
  document.getElementById('content').innerHTML = '<div class="loading"><div class="spinner"></div><br>Loading tour dates‚Ä¶</div>';
  document.getElementById('progress').style.width = '0%';
  document.getElementById('stats').innerHTML = '';

  // Fetch in batches of 6 to avoid hammering
  const batch = 6;
  for (let i = 0; i < ARTISTS.length; i += batch) {
    const chunk = ARTISTS.slice(i, i + batch);
    const results = await Promise.all(chunk.map(a => fetchArtistEvents(a)));
    results.forEach(r => allEvents.push(...r));
    loaded += chunk.length;
    document.getElementById('progress').style.width = `${(loaded/ARTISTS.length*100).toFixed(0)}%`;
  }

  allEvents.sort((a,b) => {
    if (a._houston !== b._houston) return a._houston ? -1 : 1;
    return new Date(a.datetime) - new Date(b.datetime);
  });

  // Fetch images for artists without events
  const missing = ARTISTS.filter(a => !artistImages[a]);
  for (let i = 0; i < missing.length; i += 6) {
    await Promise.all(missing.slice(i, i+6).map(async a => {
      try {
        const r = await fetch(`https://rest.bandsintown.com/artists/${encodeURIComponent(a)}?app_id=${APP_ID}`);
        if (r.ok) { const d = await r.json(); if (d.thumb_url) artistImages[a] = d.thumb_url; }
      } catch(e) {}
    }));
  }

  renderMainView();
}

function renderMainView() {
  detailArtist = null;
  inArtistList = false;
  const q = document.getElementById('search').value.toLowerCase();
  let events = allEvents;
  if (houstonOnly) events = events.filter(e => e._houston);
  if (q) events = events.filter(e =>
    (e._artist||'').toLowerCase().includes(q) ||
    (e.venue?.name||'').toLowerCase().includes(q) ||
    (e.venue?.city||'').toLowerCase().includes(q) ||
    (e.venue?.location||'').toLowerCase().includes(q)
  );

  const houstonCount = allEvents.filter(e => e._houston).length;
  const artistsWithEvents = new Set(allEvents.map(e => e._artist)).size;
  const artistsNoEvents = ARTISTS.length - artistsWithEvents;

  document.getElementById('stats').innerHTML = `
    <span><b>${allEvents.length}</b> events</span>
    <span><b>${artistsWithEvents}</b> artists touring</span>
    <span class="badge badge-houston">ü§† ${houstonCount} Houston area</span>
    ${artistsNoEvents ? `<span>${artistsNoEvents} with no dates</span>` : ''}
    ${errors.length ? `<span class="error-note">${errors.length} failed to load</span>` : ''}
  `;

  if (events.length === 0) {
    document.getElementById('content').innerHTML = '<div class="no-events">No events found</div>';
    return;
  }

  let html = `<table><thead><tr>
    <th>Artist</th><th>Date</th><th class="hide-mobile">Venue</th><th>City</th>
  </tr></thead><tbody>`;

  events.forEach(e => {
    const cls = e._houston ? ' class="houston-row"' : '';
    const badge = e._houston ? ' <span class="badge badge-houston">HTX</span>' : '';
    html += `<tr${cls} onclick="showArtist('${e._artist.replace(/'/g,"\\'")}')">
      <td class="artist-name">${esc(e._artist)}<button class="remove-artist" onclick="removeArtist('${e._artist.replace(/'/g,"\\'")}',event)" title="Remove artist">‚úï</button></td>
      <td class="date-col">${formatDate(e.datetime)}</td>
      <td class="venue-name hide-mobile"><a class="venue-link" href="${venueSearchUrl(e.venue)}" target="_blank" onclick="event.stopPropagation()">${esc(e.venue?.name||'TBA')}</a></td>
      <td class="city-name">${esc(e.venue?.city||'')}${e.venue?.region?', '+esc(e.venue.region):''}${badge}</td>
    </tr>`;
  });

  html += '</tbody></table>';
  document.getElementById('content').innerHTML = html;
}

function showArtist(name) {
  detailArtist = name;
  const events = allEvents.filter(e => e._artist === name).sort((a,b) => new Date(a.datetime) - new Date(b.datetime));
  const houstonEvents = events.filter(e => e._houston);

  const spotifyUrl = `https://open.spotify.com/search/${encodeURIComponent(name)}`;
  let html = `<button class="back-btn" onclick="renderMainView()">‚Üê Back to all events</button>`;
  html += `<div class="detail-header"><h2>${esc(name)}</h2>`;
  html += `<p>${events.length} upcoming date${events.length!==1?'s':''}`;
  if (houstonEvents.length) html += ` ¬∑ <span class="badge badge-houston">ü§† ${houstonEvents.length} Houston area</span>`;
  html += ` ¬∑ <a href="${spotifyUrl}" target="_blank" style="color:#1DB954;text-decoration:none;font-weight:600">üéß Spotify</a>`;
  html += `</p></div>`;

  if (events.length === 0) {
    html += '<div class="no-events">No upcoming events</div>';
  } else {
    html += `<table><thead><tr><th>Date</th><th>Venue</th><th>City</th></tr></thead><tbody>`;
    events.forEach(e => {
      const cls = e._houston ? ' class="houston-row"' : '';
      const badge = e._houston ? ' <span class="badge badge-houston">HTX</span>' : '';
      html += `<tr${cls}>
        <td class="date-col">${e.url ? `<a class="venue-link" href="${e.url}" target="_blank">${formatDate(e.datetime)}</a>` : formatDate(e.datetime)}</td>
        <td class="venue-name"><a class="venue-link" href="${venueSearchUrl(e.venue)}" target="_blank">${esc(e.venue?.name||'TBA')}</a></td>
        <td class="city-name">${esc(e.venue?.city||'')}${e.venue?.region?', '+esc(e.venue.region):''}${badge}</td>
      </tr>`;
    });
    html += '</tbody></table>';
  }

  document.getElementById('content').innerHTML = html;
}

function showArtistList() {
  detailArtist = null;
  inArtistList = true;
  const sorted = [...ARTISTS].sort((a,b) => a.toLowerCase().localeCompare(b.toLowerCase()));
  let html = `<button class="back-btn" onclick="renderMainView()">‚Üê Back to events</button>`;
  html += `<div class="artist-list-header"><h2>üé§ My Artists</h2><span>${ARTISTS.length} artists</span></div>`;
  html += `<div class="add-group" style="margin-bottom:16px"><input type="text" id="addArtist" placeholder="Add an artist‚Ä¶" onkeydown="if(event.key==='Enter')addNewArtist()"><button onclick="addNewArtist()">+ Add</button></div>`;
  html += `<div class="artist-list">`;
  sorted.forEach(name => {
    const events = allEvents.filter(e => e._artist === name);
    const houstonEvents = events.filter(e => e._houston);
    const info = events.length ? `${events.length} show${events.length!==1?'s':''}` : 'No shows';
    const htx = houstonEvents.length ? ` ¬∑ <span class="badge badge-houston">HTX</span>` : '';
    const img = artistImages[name] ? `<img class="artist-thumb" src="${artistImages[name]}" alt="" onerror="this.style.display='none'">` : `<div class="artist-thumb"></div>`;
    const spotUrl = `https://open.spotify.com/search/${encodeURIComponent(name)}`;
    html += `<div class="artist-list-item" onclick="showArtist('${name.replace(/'/g,"\\'")}')">
      <div class="left">${img}<div><div class="name">${esc(name)}</div><div class="info">${info}${htx}</div></div></div>
      <div style="display:flex;align-items:center;gap:6px">
        <a href="${spotUrl}" target="_blank" onclick="event.stopPropagation()" style="color:#1DB954;font-size:.85rem;text-decoration:none;opacity:.6;transition:opacity .2s" onmouseover="this.style.opacity=1" onmouseout="this.style.opacity=.6" title="Open in Spotify">üéß</a>
        <button class="remove-x" onclick="removeArtist('${name.replace(/'/g,"\\'")}',event)" title="Remove">‚úï</button>
      </div>
    </div>`;
  });
  html += `</div>`;
  document.getElementById('content').innerHTML = html;
}

function toggleHoustonFilter() {
  houstonOnly = !houstonOnly;
  document.getElementById('houstonBtn').classList.toggle('active', houstonOnly);
  if (detailArtist) showArtist(detailArtist); else renderMainView();
}

function esc(s) {
  const d = document.createElement('div');
  d.textContent = s || '';
  return d.innerHTML;
}

document.getElementById('search').addEventListener('input', () => {
  if (detailArtist) { detailArtist = null; }
  renderMainView();
});

(async () => {
  await loadArtistsFromRepo();
  fetchAllEvents();
})();
</script>
</body>
</html>
